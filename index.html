<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Mapbox GL JS map</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        /* Bottom-right image styling */
        #corner-image {
            position: absolute;
            right: 16px;
            bottom: 32px;
            z-index: 10;
        }
        .icon-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #1B1B1B;
            background-color: #6650A4;
            object-fit: cover;
            position: absolute;
            padding: 8px;
            z-index: 10;
        }
        .dropdown {
            position: relative;
            display: inline-block;
            z-index: 10;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f1f1f1;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 11;
        }
        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }
        .dropdown-content a:hover {background-color: #ddd;}
        .dropdown:hover .dropdown-content {display: block;}
        .dropdown:hover .icon-button {background-color: #D0BCFF;}
        .dropdown-item-active-style {
            font-weight: bold;
            background-color: #f0f0f0; /* Light highlight */
        }
    </style>
</head>
<body>
<div id="map">

    <a href="https://zenit-tracks.com" target="_blank" rel="noopener">
        <img 
            id="corner-image"
            src="assets/icons/ic_app_logo_map/drawable-mdpi/ic_app_logo_map.png"
            srcset="
                assets/icons/ic_app_logo_map/drawable-mdpi/ic_app_logo_map.png   1x,
                assets/icons/ic_app_logo_map/drawable-xhdpi/ic_app_logo_map.png   2x,
                assets/icons/ic_app_logo_map/drawable-xxhdpi/ic_app_logo_map.png   3x
            "
            alt="ZENIT Tracks logo"
        />
    </a>
    
    <div class="dropdown"
        id="layer-chooser-menu"
        style="top: 104px; left: 8px;" >
        <img 
            id="layer-chooser-button"
            class="icon-button"
            src="assets/icons/layers.svg"
            alt="Layers"
        />
        <div class="dropdown-content" id="layer-chooser-dropdown">
            <a href="#" data-style="mapbox://styles/bamsbamx/cm1khdwgu00np01qp4uwedovj">Satellite</a>
            <a href="#" data-style="mapbox://styles/mapbox/outdoors-v12">Terrain</a>
            <a href="#" data-style="mapbox://styles/mapbox/light-v11">Light</a>
            <a href="#" data-style="mapbox://styles/mapbox/dark-v11">Dark</a>
        </div>
    </div>
    
</div>
<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiYmFtc2JhbXgiLCJhIjoiY21nM3Qwb21pMWRzejJpcXdlbnE4eGhpdCJ9.YZ_H1DMpkx42TE_SdzyCGA';

    // Key for localStorage
    const CAMERA_STORAGE_KEY = 'mapbox_camera';

    // Restore camera state from localStorage
    let initialCenter = [0, 0];
    let initialZoom = 2;
    let initialPadding = {top: 0, bottom: 0, left: 0, right: 0};
    let initialBearing = 0;
    let initialPitch = 0;

    const savedCamera = localStorage.getItem(CAMERA_STORAGE_KEY);
    if (savedCamera) {
        try {
            const cam = JSON.parse(savedCamera);
            if (Array.isArray(cam.center) && cam.center.length === 2) initialCenter = cam.center;
            if (typeof cam.zoom === "number") initialZoom = cam.zoom;
            if (typeof cam.padding === "object" && cam.padding !== null) initialPadding = cam.padding;
            if (typeof cam.bearing === "number") initialBearing = cam.bearing;
            if (typeof cam.pitch === "number") initialPitch = cam.pitch;
        } catch (e) {}
    }

    const map = new mapboxgl.Map({
        container: 'map',
        center: initialCenter,
        zoom: initialZoom,
        padding: initialPadding,
        bearing: initialBearing,
        pitch: initialPitch,
        projection: 'globe',
        style: 'mapbox://styles/bamsbamx/cm1khdwgu00np01qp4uwedovj',
		attributionControl: false, // added later using map.addControl(new mapboxgl.AttributionControl())
    });
	
	map.addControl(new mapboxgl.FullscreenControl());
	
	map.addControl(new mapboxgl.GeolocateControl({
		positionOptions: {
			enableHighAccuracy: true
		},
		trackUserLocation: true,
		showUserHeading: true
	}));
	
	const nav = new mapboxgl.NavigationControl();
	map.addControl(nav, 'top-left');
	
	const scale = new mapboxgl.ScaleControl({
		maxWidth: 80,
		unit: 'metric'
	});
	map.addControl(scale);
	
	map.addControl(new mapboxgl.AttributionControl({
	    customAttribution: 'ZENIT Tracks'
	}), 'bottom-right');

    map.on('style.load', () => {
        map.addSource('mapbox-dem', {
            'type': 'raster-dem',
            'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
            'tileSize': 512,
            'maxzoom': 14
        });
        // add the DEM source as a terrain layer with exaggerated height
        map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });
    });
    
    const styleDropdown = document.getElementById('layer-chooser-dropdown');
    styleDropdown.addEventListener('click', (event) => {
        if (event.target.tagName === 'A') {
            event.preventDefault(); // Prevent the default anchor link behavior

            const newStyleUrl = event.target.getAttribute('data-style');

            if (newStyleUrl) {
                map.setStyle(newStyleUrl);

                const links = styleDropdown.querySelectorAll('a');
                links.forEach(link => {
                    link.classList.remove('dropdown-item-active-style');
                });

                event.target.classList.add('dropdown-item-active-style');
            }
        }
    });

    function saveCameraState() {
        const center = map.getCenter();
        const zoom = map.getZoom();
        const padding = map.getPadding ? map.getPadding() : {top: 0, bottom: 0, left: 0, right: 0};
        const bearing = map.getBearing();
        const pitch = map.getPitch();
        localStorage.setItem(
            CAMERA_STORAGE_KEY, 
            JSON.stringify({
                center: [center.lng, center.lat],
                zoom: zoom,
                padding: padding,
                bearing: bearing,
                pitch: pitch
            })
        );
    }

    map.on('moveend', saveCameraState);
    map.on('zoomend', saveCameraState);
    map.on('rotateend', saveCameraState);
    map.on('pitchend', saveCameraState);
    map.on('paddingend', saveCameraState);

</script>
</body>
</html>
